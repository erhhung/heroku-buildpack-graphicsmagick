#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

arrow() {
  sed -u 's/^/-----> /'
}

indent() {
  sed -u 's/^/       /'
}

S3_BASE_URL="http://s3.amazonaws.com/crystalvista/devtools"
TARGET_PATH="$1/vendor"
VENDOR_PATH="/app/vendor"
LIB_PATHS=""
BIN_PATHS=""

function install()
{
  local tarball destdir
  tarball="$1"
  destdir="$2"

  mkdir -p "$TARGET_PATH/$destdir"
  curl --fail --retry 3 --retry-delay 1 --connect-timeout 3 "$S3_BASE_URL/$tarball" -s -o - | tar zxf - -C "$TARGET_PATH/$destdir"

  if [ -d "$TARGET_PATH/$destdir/lib" ]; then
    LIB_PATHS="$VENDOR_PATH/$destdir/lib:$LIB_PATHS"
  fi
  if [ -d "$TARGET_PATH/$destdir/bin" ]; then
    BIN_PATHS="$VENDOR_PATH/$destdir/bin:$BIN_PATHS"
  fi
}

. "`dirname $0`/../config"

# install dependencies
echo "Installing zlib $ZLIB_VERSION" | arrow
install "$ZLIB_TARBALL" "$ZLIB_DIR"

echo "Installing nasm $NASM_VERSION" | arrow
install "$NASM_TARBALL" "$NASM_DIR"

echo "Installing libpng $LIBPNG_VERSION" | arrow
install "$LIBPNG_TARBALL" "$LIBPNG_DIR"

echo "Installing libjpeg-turbo $LIBJPEG_TURBO_VERSION" | arrow
install "$LIBJPEG_TURBO_TARBALL" "$LIBJPEG_TURBO_DIR"

# install main package
echo "Installing graphicsmagick $GRAPHICS_MAGICK_VERSION" | arrow
install "$GRAPHICS_MAGICK_TARBALL" "$GRAPHICS_MAGICK_DIR"

# configure path
cat <<EOF > "$1/.profile.d/graphicsmagick.sh"
export LD_LIBRARY_PATH="$LIB_PATHS:\$LD_LIBRARY_PATH"
export PATH="$BIN_PATHS:\$PATH"
EOF

cd "$TARGET_PATH/$GRAPHICS_MAGICK_DIR/bin"
echo "Installed: "`ls gm*` | indent
